<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A.D.D V3 - Fractal Architecture Pattern Viewer</title>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier Prime', 'Courier New', monospace;
            background: #000;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Matrix background */
        .matrix-bg {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.05;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header {
            background: #0a0a0a;
            border-bottom: 1px solid #333;
            padding: 2rem;
            position: relative;
        }

        .traffic-lights {
            display: flex;
            gap: 6px;
            margin-bottom: 1rem;
        }

        .traffic-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .traffic-light.red { background: #ff5f56; }
        .traffic-light.yellow { background: #ffbd2e; }
        .traffic-light.green { background: #27c93f; }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #999;
            font-size: 1rem;
        }

        .back-home {
            position: absolute;
            top: 2rem;
            right: 2rem;
            color: #999;
            text-decoration: none;
            font-size: 14px;
            padding: 0.5rem 1rem;
            border: 1px solid #333;
            background: #0a0a0a;
            transition: all 0.2s;
        }

        .back-home:hover {
            color: #fff;
            border-color: #fff;
            background: #1a1a1a;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: #0a0a0a;
            padding: 1rem;
            gap: 0.5rem;
            overflow-x: auto;
            border-bottom: 1px solid #333;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            border: 1px solid #333;
            background: #000;
            color: #999;
            cursor: pointer;
            font-size: 13px;
            font-family: inherit;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab-button:hover {
            background: #1a1a1a;
            color: #fff;
            border-color: #666;
        }

        .tab-button.active {
            background: #1a1a1a;
            color: #fff;
            border-color: #fff;
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            background: #0a0a0a;
            border-bottom: 1px solid #333;
        }

        .control-button {
            padding: 0.5rem 1rem;
            border: 1px solid #666;
            background: #000;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .control-button:hover {
            background: #1a1a1a;
            border-color: #fff;
        }

        .zoom-level {
            font-size: 16px;
            color: #4a9eff;
            min-width: 60px;
            text-align: center;
        }

        /* Diagram container */
        .diagram-container {
            padding: 2rem;
            min-height: 600px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            background: #000;
            overflow: auto;
        }

        .diagram-wrapper {
            display: none;
            width: 100%;
            transition: transform 0.3s ease;
            transform-origin: center top;
        }

        .diagram-wrapper.active {
            display: flex;
            justify-content: center;
        }

        .diagram-content {
            display: inline-block;
            min-height: 500px;
            padding: 1rem;
        }

        .diagram-content svg {
            max-width: none !important;
            height: auto;
        }

        /* D3 Tree Styles */
        #tree-container {
            width: 100%;
            height: 700px;
            position: relative;
            overflow: auto;
        }

        #tree-container svg {
            background: #000;
        }

        .node rect {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node rect:hover {
            filter: brightness(1.3);
            stroke-width: 4px;
        }

        .node text {
            font-size: 13px;
            font-weight: 600;
            font-family: 'Courier Prime', monospace;
            cursor: pointer;
        }

        .link {
            fill: none;
            stroke: #666;
            stroke-width: 2px;
            stroke-opacity: 0.6;
        }

        .event-arrow {
            fill: none;
            stroke: #4a9eff;
            stroke-width: 2px;
            stroke-dasharray: 6,4;
        }

        .collapse-icon {
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }

        .modal-content {
            background: #0a0a0a;
            margin: 5% auto;
            padding: 0;
            width: 80%;
            max-width: 800px;
            border: 1px solid #333;
        }

        .modal-header {
            background: #1a1a1a;
            color: white;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .close {
            color: #999;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close:hover {
            color: #fff;
        }

        .modal-body {
            padding: 2rem;
        }

        .layer-item {
            padding: 1rem;
            margin: 0.75rem 0;
            border-left: 4px solid;
            background: #1a1a1a;
            transition: all 0.2s;
        }

        .layer-item:hover {
            background: #222;
            transform: translateX(5px);
        }

        .layer-item h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            color: #fff;
        }

        .layer-item p {
            margin: 0;
            color: #999;
            font-size: 0.9rem;
        }

        .layer-bootstrap { border-left-color: #4a9eff; }
        .layer-operators { border-left-color: #27c93f; }
        .layer-core { border-left-color: #ffbd2e; }
        .layer-implementations { border-left-color: #ff5f56; }
        .layer-boundary { border-left-color: #999; }

        /* Description */
        .description {
            padding: 2rem;
            background: #0a0a0a;
            border-top: 1px solid #333;
        }

        .description h3 {
            color: #4a9eff;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .description p {
            color: #999;
            line-height: 1.7;
            font-size: 1rem;
        }

        /* Footer */
        .footer {
            padding: 1.5rem;
            text-align: center;
            background: #0a0a0a;
            color: #666;
            border-top: 1px solid #333;
        }

        .footer p {
            margin: 0.5rem 0;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #000;
        }

        ::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #606060;
        }

        /* Mermaid diagram overrides */
        .diagram-content svg text {
            fill: #fff !important;
        }

        .diagram-content .nodeLabel {
            color: #fff !important;
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .tabs {
                padding: 0.5rem;
            }

            .tab-button {
                padding: 0.5rem 1rem;
                font-size: 12px;
            }

            .back-home {
                position: static;
                display: inline-block;
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Matrix background -->
    <div class="matrix-bg" id="matrix"></div>

    <div class="container">
        <div class="header">
            <div class="traffic-lights">
                <div class="traffic-light red"></div>
                <div class="traffic-light yellow"></div>
                <div class="traffic-light green"></div>
            </div>
            <a href="index.html" class="back-home">‚Üê Back to Home</a>
            <h1>A.D.D V3 - Fractal Architecture Pattern Viewer</h1>
            <p>Interactive Visualization: Architecture & Context Reading</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="showDiagram(0)">üìä Basic Architecture</button>
            <button class="tab-button" onclick="showDiagram(1)">üîß Module Internal</button>
            <button class="tab-button" onclick="showDiagram(2)">üå≥ Infinite F.A.P Tree</button>
            <button class="tab-button" onclick="showDiagram(3)">üì° F.A.P with Events</button>
            <button class="tab-button" onclick="showDiagram(4)">üìö LLM Context Reading</button>
        </div>

        <div class="controls">
            <button class="control-button" onclick="zoomOut()">- Zoom Out</button>
            <span class="zoom-level" id="zoom-level">100%</span>
            <button class="control-button" onclick="zoomIn()">+ Zoom In</button>
            <button class="control-button" onclick="resetZoom()">‚Ü∫ Reset</button>
        </div>

        <div class="diagram-container" id="diagram-container">
            <div class="diagram-wrapper active" data-diagram="0">
                <div class="diagram-content" id="diagram-0"></div>
            </div>
            <div class="diagram-wrapper" data-diagram="1">
                <div class="diagram-content" id="diagram-1"></div>
            </div>
            <div class="diagram-wrapper" data-diagram="2">
                <div id="tree-container"></div>
            </div>
            <div class="diagram-wrapper" data-diagram="3">
                <div class="diagram-content" id="diagram-3"></div>
            </div>
            <div class="diagram-wrapper" data-diagram="4">
                <div class="diagram-content" id="diagram-4"></div>
            </div>
        </div>

        <div class="description">
            <h3 id="desc-title">üìä Basic A.D.D V3 Architecture</h3>
            <p id="desc-text">The foundation: 5 layers with clear dependencies.</p>
        </div>

        <div class="footer">
            <p>A.D.D V3 - Fractal Architecture Pattern</p>
            <p>Press 1-5 for diagrams ‚Ä¢ +/- to zoom ‚Ä¢ 0 to reset</p>
        </div>
    </div>

    <!-- Modal for 5 Layers -->
    <div id="layersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Module Layers</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="layer-item layer-bootstrap">
                    <h3>Bootstrap</h3>
                    <p>Composition Root & DI Container - wires all dependencies</p>
                </div>
                <div class="layer-item layer-operators">
                    <h3>Operators</h3>
                    <p>Business Orchestration - TGO, Coordinator, business flows</p>
                </div>
                <div class="layer-item layer-core">
                    <h3>Core Abstractions</h3>
                    <p>Entities, Ports, Events, RuleSets - contracts & domain</p>
                </div>
                <div class="layer-item layer-implementations">
                    <h3>Implementations</h3>
                    <p>Technology Adapters - DB, MQ, HTTP, ACL, Providers</p>
                </div>
                <div class="layer-item layer-boundary">
                    <h3>Boundary</h3>
                    <p>DTOs & Boundary Events - external contracts</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Local libraries -->
    <script src="lib/d3.min.js"></script>
    <script src="lib/mermaid.min.js"></script>
    <script>
        // Matrix effect
        const matrix = document.getElementById('matrix');
        const chars = '01‚ñà‚ñì‚ñí‚ñë';

        for (let i = 0; i < 30; i++) {
            const column = document.createElement('div');
            column.style.cssText = `
                position: absolute;
                top: -100px;
                font-size: 14px;
                color: #27c93f;
                animation: fall ${5 + Math.random() * 10}s linear infinite;
                animation-delay: ${Math.random() * 5}s;
                left: ${Math.random() * 100}%;
            `;
            let text = '';
            for (let j = 0; j < 20; j++) {
                text += chars[Math.floor(Math.random() * chars.length)] + '<br>';
            }
            column.innerHTML = text;
            matrix.appendChild(column);
        }

        const style = document.createElement('style');
        style.textContent = '@keyframes fall { to { transform: translateY(100vh); } }';
        document.head.appendChild(style);

        // Initialize Mermaid with dark theme
        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            securityLevel: 'loose',
            flowchart: {
                useMaxWidth: false,
                htmlLabels: true,
                curve: 'basis'
            },
            themeVariables: {
                primaryColor: '#1a1a1a',
                primaryTextColor: '#fff',
                primaryBorderColor: '#666',
                lineColor: '#666',
                secondaryColor: '#0a0a0a',
                tertiaryColor: '#333',
                background: '#000',
                mainBkg: '#1a1a1a',
                secondBkg: '#0a0a0a',
                textColor: '#fff',
                border1: '#666',
                border2: '#999'
            }
        });

        const diagrams = [
            // Diagram 0: Basic A.D.D V3 Architecture (5 Layers)
            `flowchart TD
    Bootstrap["Bootstrap<br/>Composition Root & DI"]
    Operators["Operators<br/>Business Orchestration"]
    CoreAbs["Core Abstractions<br/>Entities, Ports, Events"]
    Implementations["Implementations<br/>Technology Adapters"]
    Boundary["Boundary<br/>DTOs & External Contracts"]

    Bootstrap --> Operators
    Bootstrap --> Implementations
    Operators --> Boundary
    Operators --> CoreAbs
    Implementations --> CoreAbs

    style Bootstrap fill:#1a1a1a,stroke:#4a9eff,stroke-width:3px,color:#fff
    style Operators fill:#1a1a1a,stroke:#27c93f,stroke-width:3px,color:#fff
    style CoreAbs fill:#1a1a1a,stroke:#ffbd2e,stroke-width:3px,color:#fff
    style Implementations fill:#1a1a1a,stroke:#ff5f56,stroke-width:3px,color:#fff
    style Boundary fill:#1a1a1a,stroke:#999,stroke-width:3px,color:#fff`,

            // Diagram 1: Module Internal Structure
            `flowchart TD
    subgraph Module["ONE MODULE (Scope Module)"]
        direction TB

        subgraph Bootstrap_Layer["Bootstrap"]
            DI["DI Container<br/>Wiring"]
        end

        subgraph Operators_Layer["Operators"]
            TGO["Transaction Group<br/>Operators"]
            Coordinator["Coordinator<br/>Operators"]
        end

        subgraph Core_Layer["Core Abstractions"]
            Entities["Entities"]
            Ports["Ports<br/>(Interfaces)"]
            Events["Core Events"]
            RuleSets["RuleSets"]
        end

        subgraph Impl_Layer["Implementations"]
            Adapters["Adapters"]
            Providers["Providers"]
            ACL["Anti-Corruption<br/>Layer"]
        end

        subgraph Boundary_Layer["Boundary"]
            DTOs["DTOs"]
            BoundaryEvents["Boundary Events"]
        end

        Bootstrap_Layer --> Operators_Layer
        Bootstrap_Layer --> Impl_Layer
        Operators_Layer --> Core_Layer
        Operators_Layer --> Boundary_Layer
        Impl_Layer --> Core_Layer
    end

    style Module fill:#000,stroke:#666,stroke-width:2px
    style Bootstrap_Layer fill:#0a0a0a,stroke:#4a9eff,stroke-width:2px,color:#fff
    style Operators_Layer fill:#0a0a0a,stroke:#27c93f,stroke-width:2px,color:#fff
    style Core_Layer fill:#0a0a0a,stroke:#ffbd2e,stroke-width:2px,color:#fff
    style Impl_Layer fill:#0a0a0a,stroke:#ff5f56,stroke-width:2px,color:#fff
    style Boundary_Layer fill:#0a0a0a,stroke:#999,stroke-width:2px,color:#fff`,

            null, // Diagram 2 will be D3.js tree

            // Diagram 3: F.A.P with Event Communication
            `flowchart TD
    Root["System Root<br/>(Module with 5 layers)"]

    ModA["Module A<br/>(5 layers)"]
    ModB["Module B<br/>(5 layers)"]
    ModC["Module C<br/>(5 layers)"]

    ModB1["Module B1<br/>(5 layers)"]
    ModB2["Module B2<br/>(5 layers)"]

    Root -->|contains in<br/>Implementations| ModA
    Root -->|contains in<br/>Implementations| ModB
    Root -->|contains in<br/>Implementations| ModC

    ModB -->|contains in<br/>Implementations| ModB1
    ModB -->|contains in<br/>Implementations| ModB2

    ModA -.->|Core Event| ModB
    ModB1 -.->|Core Event| ModB2
    ModB -.->|Core Event| ModC

    style Root fill:#1a1a1a,stroke:#4a9eff,stroke-width:3px,color:#fff
    style ModA fill:#1a1a1a,stroke:#27c93f,stroke-width:2px,color:#fff
    style ModB fill:#1a1a1a,stroke:#ff5f56,stroke-width:2px,color:#fff
    style ModC fill:#1a1a1a,stroke:#999,stroke-width:2px,color:#fff
    style ModB1 fill:#0a0a0a,stroke:#ffbd2e,stroke-width:2px,color:#fff
    style ModB2 fill:#0a0a0a,stroke:#4a9eff,stroke-width:2px,color:#fff`,

            // Diagram 4: LLM Context Reading
            `flowchart TD
    subgraph L0["LEVEL 0: GLOBAL ARCHITECTURE"]
        L0Info["A.D.D V3 Fractal (F.A.P)<br/>Self-similar structure<br/>Infinite nesting"]
    end

    subgraph L1["LEVEL 1: ROOT MODULE"]
        L1Info["Module: System Root<br/>5 Layers<br/>Path: /"]
    end

    subgraph L2["LEVEL 2: IMPLEMENTATIONS LAYER"]
        L2Info["Layer: Implementations<br/>Contains: Sub-modules<br/>Path: /Implementations"]
    end

    subgraph L3["LEVEL 3: SUB-MODULE"]
        L3Info["Module: A<br/>5 Layers<br/>Path: /Implementations/A"]
    end

    subgraph L4["LEVEL 4: SUB-IMPLEMENTATIONS"]
        L4Info["Layer: Implementations<br/>Contains: Components<br/>Path: /Implementations/A/Implementations"]
    end

    subgraph L5["LEVEL 5: CODE"]
        L5Code["class UserRepository<br/>  implements IUserRepo<br/>Path: .../UserRepo.ts"]
    end

    L0 --> L1
    L1 --> L2
    L2 --> L3
    L3 --> L4
    L4 --> L5

    style L0 fill:#1a1a1a,stroke:#4a9eff,stroke-width:3px,color:#fff
    style L1 fill:#1a1a1a,stroke:#27c93f,stroke-width:2px,color:#fff
    style L2 fill:#1a1a1a,stroke:#ffbd2e,stroke-width:2px,color:#fff
    style L3 fill:#1a1a1a,stroke:#ff5f56,stroke-width:2px,color:#fff
    style L4 fill:#1a1a1a,stroke:#999,stroke-width:2px,color:#fff
    style L5 fill:#0a0a0a,stroke:#666,stroke-width:1px,color:#999`
        ];

        const descriptions = [
            {
                title: "üìä Basic A.D.D V3 Architecture",
                text: "The foundation of A.D.D V3: 5 layers with clear separation.<br><br><strong>Layer Responsibilities:</strong><br>‚Ä¢ <span style='color:#4a9eff'>Bootstrap</span> - wires all dependencies<br>‚Ä¢ <span style='color:#27c93f'>Operators</span> - orchestrate business logic<br>‚Ä¢ <span style='color:#ffbd2e'>Core Abstractions</span> - define contracts & domain<br>‚Ä¢ <span style='color:#ff5f56'>Implementations</span> - provide technology adapters<br>‚Ä¢ <span style='color:#999'>Boundary</span> - define external contracts<br><br>This is the atomic unit that repeats in Fractal Architecture Pattern."
            },
            {
                title: "üîß Module Internal Structure",
                text: "Zooming into ONE module (Scope Module) to see the 5 layers in detail.<br><br><strong>Layer Components:</strong><br>‚Ä¢ <span style='color:#4a9eff'>Bootstrap</span> - DI Container, Composition Root<br>‚Ä¢ <span style='color:#27c93f'>Operators</span> - TGO, Coordinator, Business Flows<br>‚Ä¢ <span style='color:#ffbd2e'>Core Abstractions</span> - Entities, Ports, Events, RuleSets<br>‚Ä¢ <span style='color:#ff5f56'>Implementations</span> - Adapters, Providers, ACL<br>‚Ä¢ <span style='color:#999'>Boundary</span> - DTOs, Boundary Events<br><br>Each module is self-contained with full A.D.D structure."
            },
            {
                title: "üå≥ Fractal Architecture Pattern - Infinite Tree (Lazy Loading)",
                text: "Infinite Fractal with 6 node types: Module + 5 Layers.<br><br><strong>Expansion Rule:</strong><br>‚Ä¢ Only Implementations can contain children<br>‚Ä¢ Click ‚ñº on Implementations ‚Üí lazy creates random 1-5 sub-modules<br>‚Ä¢ Each sub-module has same 5-layer structure (fractal repeats!)<br><br><strong>Interactions:</strong><br>‚Ä¢ Keep expanding Implementations infinitely to explore the tree<br>‚Ä¢ Blue dashed arrow = Event from root Implementations ‚Üí Boundary<br>‚Ä¢ Click node name to view 5 layers modal"
            },
            {
                title: "üì° F.A.P with Event Communication (Pure Fractal)",
                text: "Pure Fractal with event communication. Every module has full 5-layer structure (shown as simplified notation).<br><br><strong>Visual Elements:</strong><br>‚Ä¢ Vertical arrows (<em>\"contains in Implementations\"</em>) = fractal containment<br>‚Ä¢ Dotted horizontal arrows = Core Events for cross-module communication<br><br><strong>Communication Rules:</strong><br>‚Ä¢ Modules communicate ONLY via Core Events and Ports<br>‚Ä¢ Never direct calls between modules<br>‚Ä¢ Each module is self-contained and testable independently"
            },
            {
                title: "üìö LLM Context Reading - Pure Fractal Navigation",
                text: "Shows how LLMs navigate the F.A.P tree vertically to read context at ANY depth:<br><br>‚Ä¢ <strong>Level 0:</strong> Global pattern (F.A.P = self-similar structure)<br>‚Ä¢ <strong>Level 1:</strong> Root Module (5 layers)<br>‚Ä¢ <strong>Level 2:</strong> Implementations layer ‚Üí sub-modules visible<br>‚Ä¢ <strong>Level 3:</strong> Sub-Module A (5 layers - fractal repeats!)<br>‚Ä¢ <strong>Level 4:</strong> Sub-Module A's Implementations ‚Üí components visible<br>‚Ä¢ <strong>Level 5:</strong> Actual code files<br><br>Path notation shows location in tree. LLMs can read context at each level independently."
            }
        ];

        // Infinite Fractal with Lazy Loading
        let moduleCounter = 0;

        function createModule(name, depth = 0, isRoot = false) {
            const module = {
                name: name,
                type: "module",
                color: "#1a1a1a",
                stroke: "#4a9eff",
                depth: depth,
                id: `module-${moduleCounter++}`,
                children: [
                    {
                        name: "Bootstrap",
                        type: "bootstrap",
                        color: "#0a0a0a",
                        stroke: "#4a9eff",
                        id: `bootstrap-${moduleCounter++}`
                    },
                    {
                        name: "Operators",
                        type: "operators",
                        color: "#0a0a0a",
                        stroke: "#27c93f",
                        id: `operators-${moduleCounter++}`
                    },
                    {
                        name: "Core Abstractions",
                        type: "core",
                        color: "#0a0a0a",
                        stroke: "#ffbd2e",
                        id: `core-${moduleCounter++}`
                    },
                    {
                        name: "Implementations",
                        type: "implementations",
                        color: "#0a0a0a",
                        stroke: "#ff5f56",
                        hasEvent: isRoot,
                        eventTarget: 4,
                        canExpand: true,
                        depth: depth,
                        id: `impl-${moduleCounter++}`
                    },
                    {
                        name: "Boundary",
                        type: "boundary",
                        color: "#0a0a0a",
                        stroke: "#999",
                        id: `boundary-${moduleCounter++}`
                    }
                ]
            };

            return module;
        }

        let subModuleCounter = 0;
        const moduleLabels = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];

        function lazyCreateImplementationsChildren(implNode) {
            if (implNode.children) return;

            const childrenCount = Math.floor(Math.random() * 5) + 1;
            implNode.children = [];
            for (let i = 0; i < childrenCount; i++) {
                const label = moduleLabels[subModuleCounter % moduleLabels.length];
                const name = `Module ${label}`;
                subModuleCounter++;
                implNode.children.push(createModule(name, implNode.depth + 1, false));
            }
        }

        const treeData = createModule("System Root", 0, true);

        // D3 Tree Rendering
        let treeRendered = false;

        function renderTree() {
            if (treeRendered) return;
            treeRendered = true;

            const nodeWidth = 150;
            const nodeHeight = 80;
            const levelHeight = 150;
            const minWidth = 1400;
            const minHeight = 650;

            const svg = d3.select("#tree-container")
                .append("svg");

            const g = svg.append("g")
                .attr("transform", "translate(50,30)");

            svg.append("defs").append("marker")
                .attr("id", "arrowhead")
                .attr("markerWidth", 10)
                .attr("markerHeight", 10)
                .attr("refX", 9)
                .attr("refY", 3)
                .attr("orient", "auto")
                .append("polygon")
                .attr("points", "0 0, 10 3, 0 6")
                .attr("fill", "#4a9eff");

            let root = d3.hierarchy(treeData);

            root.descendants().forEach((d, i) => {
                d._children = d.children;
                if (d.depth > 0) d.children = null;
            });

            function rebuildTree() {
                const newRoot = d3.hierarchy(treeData);

                function restoreState(oldNode, newNode) {
                    if (!oldNode || !newNode) {
                        if (newNode && newNode.data.type === "module" && newNode.children) {
                            newNode._children = newNode.children;
                            newNode.children = null;
                        }
                        return;
                    }

                    if (oldNode._children && !oldNode.children) {
                        newNode._children = newNode.children;
                        newNode.children = null;
                    }

                    if (newNode.children) {
                        newNode.children.forEach((newChild, i) => {
                            const oldChild = oldNode.children ? oldNode.children[i] :
                                            (oldNode._children ? oldNode._children[i] : null);
                            restoreState(oldChild, newChild);
                        });
                    }
                    if (newNode._children) {
                        newNode._children.forEach((newChild, i) => {
                            const oldChild = oldNode._children ? oldNode._children[i] : null;
                            restoreState(oldChild, newChild);
                        });
                    }
                }

                restoreState(root, newRoot);
                root = newRoot;
            }

            function update(source) {
                g.selectAll("*").remove();

                const nodes = root.descendants().filter(d => {
                    let node = d;
                    while (node.parent) {
                        if (!node.parent.children || !node.parent.children.includes(node)) {
                            return false;
                        }
                        node = node.parent;
                    }
                    return true;
                });

                const levels = {};
                nodes.forEach(d => {
                    if (!levels[d.depth]) levels[d.depth] = [];
                    levels[d.depth].push(d);
                });

                const maxDepth = Math.max(...Object.keys(levels).map(Number));
                const maxNodesInLevel = Math.max(...Object.values(levels).map(arr => arr.length));
                const requiredWidth = Math.max(minWidth, maxNodesInLevel * (nodeWidth + 50) + 100);
                const requiredHeight = Math.max(minHeight, (maxDepth + 1) * levelHeight + 100);

                svg.attr("width", requiredWidth)
                   .attr("height", requiredHeight);

                Object.keys(levels).forEach(depth => {
                    const nodesInLevel = levels[depth];
                    const totalWidth = nodesInLevel.length * (nodeWidth + 50);
                    const startX = (requiredWidth - totalWidth) / 2;

                    nodesInLevel.forEach((node, i) => {
                        node.x = startX + i * (nodeWidth + 50) + nodeWidth / 2;
                        node.y = depth * levelHeight + nodeHeight / 2;
                    });
                });

                const links = root.links().filter(d => nodes.includes(d.source) && nodes.includes(d.target));

                links.forEach(link => {
                    g.append("path")
                        .attr("class", "link")
                        .attr("d", `M${link.source.x},${link.source.y + nodeHeight/2}
                                    V${(link.source.y + link.target.y) / 2}
                                    H${link.target.x}
                                    V${link.target.y - nodeHeight/2}`);
                });

                const arrowsByDepth = {};
                nodes.forEach(sourceNode => {
                    if (sourceNode.data.hasEvent && sourceNode.data.eventTarget !== undefined) {
                        const parentNode = sourceNode.parent;
                        if (parentNode && parentNode.children) {
                            const siblings = parentNode.children;
                            const targetNode = siblings[sourceNode.data.eventTarget];
                            if (targetNode && nodes.includes(targetNode)) {
                                if (!arrowsByDepth[sourceNode.depth]) {
                                    arrowsByDepth[sourceNode.depth] = [];
                                }
                                arrowsByDepth[sourceNode.depth].push({ sourceNode, targetNode });
                            }
                        }
                    }
                });

                Object.entries(arrowsByDepth).forEach(([depth, arrows]) => {
                    const totalArrows = arrows.length;
                    arrows.forEach((arrow, index) => {
                        const { sourceNode, targetNode } = arrow;
                        const offsetRange = 20;
                        const yOffset = totalArrows > 1
                            ? (index / (totalArrows - 1)) * offsetRange - offsetRange / 2
                            : 0;

                        g.append("path")
                            .attr("class", "event-arrow")
                            .attr("d", `M${sourceNode.x + nodeWidth/2},${sourceNode.y + yOffset}
                                        L${targetNode.x - nodeWidth/2},${targetNode.y + yOffset}`)
                            .attr("marker-end", "url(#arrowhead)");
                    });
                });

                nodes.forEach(d => {
                    const nodeGroup = g.append("g")
                        .attr("class", "node")
                        .attr("transform", `translate(${d.x - nodeWidth/2},${d.y - nodeHeight/2})`);

                    nodeGroup.append("rect")
                        .attr("width", nodeWidth)
                        .attr("height", nodeHeight)
                        .style("fill", d.data.color)
                        .style("stroke", d.data.stroke)
                        .style("stroke-width", 2)
                        .on("click", (event) => {
                            if (d.data.type === "implementations" && d.data.canExpand && !d.data.children && !d._children) {
                                lazyCreateImplementationsChildren(d.data);
                                rebuildTree();
                            }

                            if (d._children) {
                                d.children = d._children;
                                d._children = null;
                            } else if (d.children) {
                                d._children = d.children;
                                d.children = null;
                            }
                            update(d);
                        });

                    nodeGroup.append("text")
                        .attr("x", nodeWidth / 2)
                        .attr("y", nodeHeight / 2)
                        .attr("dy", "0.35em")
                        .attr("text-anchor", "middle")
                        .text(d.data.name)
                        .style("fill", "#fff")
                        .on("click", (event) => {
                            showLayersModal(d.data.name);
                        });

                    if (d._children || d.children || (d.data.type === "implementations" && d.data.canExpand)) {
                        nodeGroup.append("text")
                            .attr("class", "collapse-icon")
                            .attr("x", nodeWidth / 2)
                            .attr("y", nodeHeight + 15)
                            .attr("text-anchor", "middle")
                            .text(d.children ? "‚ñ≤" : "‚ñº")
                            .style("fill", "#4a9eff")
                            .on("click", (event) => {
                                event.stopPropagation();

                                if (d.data.type === "implementations" && d.data.canExpand && !d.data.children && !d._children) {
                                    lazyCreateImplementationsChildren(d.data);
                                    rebuildTree();
                                }

                                if (d._children) {
                                    d.children = d._children;
                                    d._children = null;
                                } else if (d.children) {
                                    d._children = d.children;
                                    d.children = null;
                                }
                                update(d);
                            });
                    }
                });
            }

            update(root);
        }

        // Modal functions
        function showLayersModal(moduleName) {
            document.getElementById('modal-title').textContent = `${moduleName} - 5 Layers`;
            document.getElementById('layersModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('layersModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('layersModal');
            if (event.target === modal) {
                closeModal();
            }
        };

        // Render Mermaid diagrams
        async function renderDiagrams() {
            for (let i = 0; i < diagrams.length; i++) {
                if (diagrams[i] === null) continue;
                try {
                    const { svg } = await mermaid.render(`diagram-${i}-svg`, diagrams[i]);
                    document.getElementById(`diagram-${i}`).innerHTML = svg;
                } catch (error) {
                    console.error(`Error rendering diagram ${i}:`, error);
                    document.getElementById(`diagram-${i}`).innerHTML = `<div style="padding:20px;color:#ff5f56;border:1px solid #ff5f56;">
                        <h3>Error rendering diagram ${i}</h3>
                        <pre style="margin-top:10px;font-size:12px;">${error.message}</pre>
                    </div>`;
                }
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', renderDiagrams);
        } else {
            renderDiagrams();
        }

        // Global functions
        function showDiagram(index) {
            const wrappers = document.querySelectorAll('.diagram-wrapper');
            wrappers.forEach(d => d.classList.remove('active'));

            const selectedDiagram = document.querySelector(`[data-diagram="${index}"]`);
            if (selectedDiagram) {
                selectedDiagram.classList.add('active');
            }

            const tabs = document.querySelectorAll('.tab-button');
            tabs.forEach((t, i) => {
                if (i === index) {
                    t.classList.add('active');
                } else {
                    t.classList.remove('active');
                }
            });

            document.getElementById('desc-title').textContent = descriptions[index].title;
            document.getElementById('desc-text').innerHTML = descriptions[index].text;

            if (index === 2) {
                renderTree();
            }

            resetZoom();
        }

        let currentZoom = 1.0;
        const zoomStep = 0.2;
        const minZoom = 0.5;
        const maxZoom = 3.0;

        function updateZoom() {
            const activeWrapper = document.querySelector('.diagram-wrapper.active');
            if (activeWrapper) {
                activeWrapper.style.transform = `scale(${currentZoom})`;
            }
            document.getElementById('zoom-level').textContent = `${Math.round(currentZoom * 100)}%`;
        }

        function zoomIn() {
            if (currentZoom < maxZoom) {
                currentZoom += zoomStep;
                updateZoom();
            }
        }

        function zoomOut() {
            if (currentZoom > minZoom) {
                currentZoom -= zoomStep;
                updateZoom();
            }
        }

        function resetZoom() {
            currentZoom = 1.0;
            updateZoom();
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === '+' || e.key === '=') {
                zoomIn();
            } else if (e.key === '-' || e.key === '_') {
                zoomOut();
            } else if (e.key === '0') {
                resetZoom();
            } else if (e.key >= '1' && e.key <= '5') {
                showDiagram(parseInt(e.key) - 1);
            } else if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>
